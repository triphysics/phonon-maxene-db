<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>MAXene Material Viewer</title>
    <script src="https://3Dmol.csb.pitt.edu/build/3Dmol-min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
            max-width: 960px;
            margin: auto;
            padding: 1rem;
            line-height: 1.6;
        }
        h1, h2 {
            color: #2c3e50;
            border-bottom: 1px solid #ccc;
            padding-bottom: 4px;
        }
        .structure, .phonon {
            margin-top: 1rem;
        }
        #viewer {
            width: 100%;
            height: 400px;
            border: 1px solid #ddd;
        }
        #phononPlot {
            width: 100%;
            height: 400px;
        }
        .info-table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 1rem;
        }
        .info-table th, .info-table td {
            border: 1px solid #ccc;
            padding: 6px 10px;
            text-align: left;
        }
        .info-table th {
            background-color: #f2f2f2;
        }
        .section {
            margin-top: 2rem;
        }
        .error {
            color: red;
            padding: 10px;
            background-color: #ffebee;
            border: 1px solid #f44336;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Material: Ti<sub>2</sub>C</h1>
    
    <div class="structure section">
        <h2>ðŸ§Š Structure</h2>
        <div id="viewer"></div>
        <div id="structureError" class="error" style="display: none;"></div>
    </div>
    
    <div class="section">
        <h2>ðŸ§® Structural Details</h2>
        <table class="info-table" id="latticeTable">
            <thead><tr><th colspan="4">Lattice Vectors (Ã…)</th></tr></thead>
            <tbody></tbody>
        </table>
        <table class="info-table" id="atomTable">
            <thead><tr><th>Element</th><th>x</th><th>y</th><th>z</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
    
    <div class="phonon section">
        <h2>ðŸŽµ Phonon Band Structure</h2>
        <div id="phononPlot"></div>
        <div id="phononError" class="error" style="display: none;"></div>
    </div>

    <script>
        // Initialize 3Dmol viewer
        let viewer = $3Dmol.createViewer("viewer", { backgroundColor: "white" });
        
        // Function to show error messages
        function showError(elementId, message) {
            const errorDiv = document.getElementById(elementId);
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        // Try to load structure file (check for CIF first, then POSCAR)
        function loadStructure() {
            // First try CIF format
            fetch("POSCAR.cif")
                .then(response => {
                    if (!response.ok) {
                        throw new Error('CIF file not found');
                    }
                    return response.text();
                })
                .then(data => {
                    viewer.addModel(data, "cif");
                    viewer.setStyle({}, { stick: {}, sphere: { scale: 0.3 } });
                    viewer.showUnitCell(true);
                    viewer.zoomTo();
                    viewer.render();
                })
                .catch(error => {
                    console.log("CIF not found, trying POSCAR format...");
                    // If CIF fails, try POSCAR format
                    loadPOSCAR();
                });
        }
        
        function loadPOSCAR() {
            fetch("POSCAR")
                .then(response => {
                    if (!response.ok) {
                        throw new Error('POSCAR file not found');
                    }
                    return response.text();
                })
                .then(data => {
                    // Convert POSCAR to XYZ format for 3Dmol
                    const xyzData = convertPOSCARToXYZ(data);
                    viewer.addModel(xyzData, "xyz");
                    viewer.setStyle({}, { stick: {}, sphere: { scale: 0.3 } });
                    viewer.zoomTo();
                    viewer.render();
                })
                .catch(error => {
                    showError('structureError', 'Could not load structure files (POSCAR.cif or POSCAR). Please ensure files are in the correct directory.');
                });
        }
        
        function convertPOSCARToXYZ(poscarText) {
            try {
                const lines = poscarText.trim().split('\n');
                const scale = parseFloat(lines[1]);
                const lattice = lines.slice(2, 5).map(line => 
                    line.trim().split(/\s+/).map(parseFloat)
                );
                const elements = lines[5].trim().split(/\s+/);
                const counts = lines[6].trim().split(/\s+/).map(Number);
                
                // Check if coordinates are in direct or cartesian
                const coordType = lines[7].trim().toLowerCase();
                const isDirect = coordType.startsWith('d');
                
                const totalAtoms = counts.reduce((a, b) => a + b, 0);
                const positions = lines.slice(8, 8 + totalAtoms).map(l => 
                    l.trim().split(/\s+/).map(Number).slice(0, 3)
                );
                
                let xyzContent = `${totalAtoms}\nConverted from POSCAR\n`;
                let idx = 0;
                
                elements.forEach((el, i) => {
                    for (let j = 0; j < counts[i]; j++) {
                        let [x, y, z] = positions[idx++];
                        
                        if (isDirect) {
                            // Convert direct coordinates to cartesian
                            const cartX = x * lattice[0][0] + y * lattice[1][0] + z * lattice[2][0];
                            const cartY = x * lattice[0][1] + y * lattice[1][1] + z * lattice[2][1];
                            const cartZ = x * lattice[0][2] + y * lattice[1][2] + z * lattice[2][2];
                            x = cartX * scale;
                            y = cartY * scale;
                            z = cartZ * scale;
                        } else {
                            x *= scale;
                            y *= scale;
                            z *= scale;
                        }
                        
                        xyzContent += `${el} ${x.toFixed(6)} ${y.toFixed(6)} ${z.toFixed(6)}\n`;
                    }
                });
                
                return xyzContent;
            } catch (error) {
                throw new Error('Error parsing POSCAR file: ' + error.message);
            }
        }
        
        // Load structure
        loadStructure();
        
        // Parse and display POSCAR data for tables
        fetch("POSCAR")
            .then(response => response.text())
            .then(text => {
                const lines = text.trim().split('\n');
                const scale = parseFloat(lines[1]);
                const lattice = lines.slice(2, 5).map(line => 
                    line.trim().split(/\s+/).map(parseFloat)
                );
                const elements = lines[5].trim().split(/\s+/);
                const counts = lines[6].trim().split(/\s+/).map(Number);
                
                const coordType = lines[7].trim().toLowerCase();
                const isDirect = coordType.startsWith('d');
                const totalAtoms = counts.reduce((a, b) => a + b, 0);
                const positions = lines.slice(8, 8 + totalAtoms).map(l => 
                    l.trim().split(/\s+/).map(Number).slice(0, 3)
                );
                
                // Fill lattice table
                const latticeTable = document.querySelector("#latticeTable tbody");
                lattice.forEach((v, i) => {
                    let row = `<tr><td>v${i+1}</td><td>${(v[0]*scale).toFixed(4)}</td><td>${(v[1]*scale).toFixed(4)}</td><td>${(v[2]*scale).toFixed(4)}</td></tr>`;
                    latticeTable.innerHTML += row;
                });
                
                // Fill atom table
                const atomTable = document.querySelector("#atomTable tbody");
                let idx = 0;
                elements.forEach((el, i) => {
                    for (let j = 0; j < counts[i]; j++) {
                        const [x, y, z] = positions[idx++];
                        atomTable.innerHTML += `<tr><td>${el}</td><td>${x.toFixed(4)}</td><td>${y.toFixed(4)}</td><td>${z.toFixed(4)}</td></tr>`;
                    }
                });
            })
            .catch(error => {
                console.log("Could not load POSCAR for table data");
            });
        
        // Plot phonon band structure
        fetch("phononband.json")
            .then(res => {
                if (!res.ok) {
                    throw new Error('phononband.json not found');
                }
                return res.json();
            })
            .then(data => {
                // Handle different possible JSON structures
                let frequencies, qpoints;
                
                if (data.frequencies && data.qpoints) {
                    frequencies = data.frequencies;
                    qpoints = data.qpoints;
                } else if (data.phonon && data.phonon.frequencies) {
                    frequencies = data.phonon.frequencies;
                    qpoints = data.phonon.qpoints || Array.from({length: frequencies.length}, (_, i) => i);
                } else {
                    throw new Error('Unexpected JSON structure in phononband.json');
                }
                
                const traces = frequencies[0].map((_, i) => ({
                    x: qpoints,
                    y: frequencies.map(f => f[i]),
                    mode: 'lines',
                    line: { width: 1 },
                    name: `Mode ${i + 1}`
                }));
                
                const layout = {
                    title: "Phonon Dispersion",
                    xaxis: { 
                        title: "q-point",
                        showgrid: false 
                    },
                    yaxis: { 
                        title: "Frequency (THz)" 
                    },
                    showlegend: false
                };
                
                Plotly.newPlot("phononPlot", traces, layout);
            })
            .catch(error => {
                showError('phononError', 'Could not load phononband.json. Please ensure the file exists and has the correct format.');
                console.error('Phonon loading error:', error);
            });
    </script>
</body>
</html>

