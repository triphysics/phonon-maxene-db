<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MAXene Material Viewer</title>
  <script src="https://3Dmol.csb.pitt.edu/build/3Dmol-min.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 2rem auto;
      max-width: 960px;
      background: #f0f2f5;
    }
    h1 {
      text-align: center;
      background: linear-gradient(45deg, #3498db, #2c3e50);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .viewer-controls, .section {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      margin-top: 1rem;
    }
    #viewer {
      width: 100%;
      height: 500px;
      border: 2px solid #3498db;
      border-radius: 10px;
      margin-top: 1rem;
    }
    #phononPlot {
      width: 100%;
      height: 450px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    label, select, button {
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <h1 id="material-title">Material Viewer</h1>

  <!-- Structure Viewer -->
  <div class="section">
    <h2>üßä Crystal Structure</h2>
    <div id="structureStatus">Loading structure...</div>

    <div class="viewer-controls">
      <label><input type="checkbox" id="bonds-toggle" checked /> Bonds</label>
      <label><input type="checkbox" id="packed-toggle" /> Packed cell</label>

      <div style="margin-top: 10px;">
        Supercell: 
        <select id="scell-x"><option>1</option><option>2</option><option selected>3</option><option>4</option></select> √ó
        <select id="scell-y"><option>1</option><option>2</option><option selected>3</option><option>4</option></select> √ó
        <select id="scell-z"><option>1</option><option selected>1</option><option>2</option></select>
      </div>

      <div style="margin-top: 10px;">
        Camera: 
        <button id="view-x">X</button>
        <button id="view-y">Y</button>
        <button id="view-z">Z</button>
        <button id="home-btn">üè† Reset</button>
      </div>

      <div style="margin-top: 10px;">
        <label><input type="checkbox" id="labels-toggle" /> Atom labels</label>
      </div>
    </div>

    <div id="viewer"></div>
  </div>

  <!-- Phonon Band Structure -->
  <div class="section">
    <h2>üéµ Phonon Band Structure</h2>
    <div id="phononStatus">Loading phonon dispersion...</div>
    <div id="phononPlot"></div>
  </div>

<script>
let viewer = null;
let rawCifData = "";
let atomLabels = [];
let labelsVisible = false;
let currentBonds = true;
let useVDW = false;
let supercell = [3, 3, 1];

function renderStructure() {
  if (!viewer || !rawCifData) return;

  viewer.clear();
  const model = viewer.addModel(rawCifData, "cif");
  model.replicateUnitCell(supercell[0], supercell[1], supercell[2]);

  model.setStyle({}, {
    stick: currentBonds ? { radius: 0.15 } : {},
    sphere: useVDW ? { scale: 1.0 } : { scale: 0.35 }
  });

  viewer.addUnitCell();

  atomLabels.forEach(label => viewer.removeLabel(label));
  atomLabels = [];

  if (labelsVisible) {
    const atoms = viewer.selectedAtoms();
    atoms.forEach(atom => {
      const label = viewer.addLabel(atom.elem, {
        position: { x: atom.x, y: atom.y, z: atom.z + 0.5 },
        fontSize: 14,
        fontColor: "black",
        showBackground: false
      });
      atomLabels.push(label);
    });
  }

  viewer.zoomTo();
  viewer.render();
}

function load3DStructure() {
  viewer = $3Dmol.createViewer('viewer', {
    backgroundColor: "white"
  });

  fetch("POSCAR.cif")
    .then(res => res.text())
    .then(cifData => {
      rawCifData = cifData;
      renderStructure();
      document.getElementById("structureStatus").innerHTML =
        `<div class="success">‚úì Structure loaded</div>`;
    })
    .catch(err => {
      document.getElementById("structureStatus").innerHTML =
        `<div class="error">Error loading CIF: ${err.message}</div>`;
    });
}

function loadPhononData() {
  fetch("data/band.yaml")
    .then(r => r.text())
    .then(yamlText => {
      const data = jsyaml.load(yamlText);
      const phonon = data.phonon;
      const numBands = phonon[0].band.length;
      const traces = [];

      for (let i = 0; i < numBands; i++) {
        traces.push({
          x: phonon.map(p => p.distance),
          y: phonon.map(p => p.band[i].frequency),
          mode: 'lines',
          line: { width: 2 },
          showlegend: false,
          name: `Mode ${i + 1}`
        });
      }

      const rawLabels = data.labels ? data.labels.flat() : [];
      const labels = [rawLabels[0]];
      for (let i = 1; i < rawLabels.length; i++) {
        if (rawLabels[i] !== rawLabels[i - 1]) {
          labels.push(rawLabels[i]);
        }
      }

      const segmentNq = data.segment_nqpoint || [];
      const labelPositions = [];
      let index = 0;
      for (let i = 0; i < segmentNq.length; i++) {
        labelPositions.push(phonon[index].distance);
        index += segmentNq[i];
      }
      labelPositions.push(phonon[phonon.length - 1].distance);

      const layout = {
        title: 'Phonon Dispersion',
        xaxis: {
          title: 'Wave Vector',
          tickvals: labelPositions,
          ticktext: labels,
          showgrid: true
        },
        yaxis: {
          title: 'Frequency (THz)',
          zeroline: true,
          showgrid: true
        },
        plot_bgcolor: 'white',
        paper_bgcolor: 'white',
        margin: { l: 60, r: 30, t: 50, b: 60 }
      };

      Plotly.newPlot('phononPlot', traces, layout);
      document.getElementById("phononStatus").innerHTML =
        `<div class="success">‚úì Phonon data loaded</div>`;
    })
    .catch(err => {
      document.getElementById("phononStatus").innerHTML =
        `<div class="error">Error loading band.yaml: ${err.message}</div>`;
    });
}

document.addEventListener('DOMContentLoaded', () => {
  load3DStructure();
  loadPhononData();

  document.getElementById('bonds-toggle').addEventListener('change', e => {
    currentBonds = e.target.checked;
    renderStructure();
  });

  document.getElementById('packed-toggle').addEventListener('change', e => {
    useVDW = e.target.checked;
    renderStructure();
  });

  document.getElementById('labels-toggle').addEventListener('change', e => {
    labelsVisible = e.target.checked;
    renderStructure();
  });

  ['scell-x', 'scell-y', 'scell-z'].forEach((id, i) => {
    document.getElementById(id).addEventListener('change', () => {
      supercell[i] = parseInt(document.getElementById(id).value);
      renderStructure();
    });
  });

  document.getElementById('home-btn').addEventListener('click', () => {
    viewer.zoomTo();
    viewer.render();
  });

  document.getElementById('view-x').addEventListener('click', () => {
    viewer.rotate(0, 0);
    viewer.zoomTo();
    viewer.render();
  });

  document.getElementById('view-y').addEventListener('click', () => {
    viewer.rotate(0, 90);
    viewer.zoomTo();
    viewer.render();
  });

  document.getElementById('view-z').addEventListener('click', () => {
    viewer.rotate(90, 0);
    viewer.zoomTo();
    viewer.render();
  });

  const pathParts = window.location.pathname.split('/');
  const folderName = pathParts[pathParts.length - 2] || "Unknown";
  document.getElementById("material-title").innerHTML =
    `Material: ${folderName}`;
});
</script>
</body>
</html>

