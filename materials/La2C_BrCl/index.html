<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MAXene Material Viewer</title>
  <script src="https://3Dmol.csb.pitt.edu/build/3Dmol-min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 2rem auto;
      max-width: 960px;
      background: #f0f2f5;
    }
    h1 {
      text-align: center;
      background: linear-gradient(45deg, #3498db, #2c3e50);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .viewer-controls {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      margin-top: 1rem;
    }
    #viewer {
      width: 100%;
      height: 500px;
      border: 2px solid #3498db;
      border-radius: 10px;
      margin-top: 1rem;
    }
    label {
      margin-right: 10px;
    }
    select, button, input[type="checkbox"] {
      margin-right: 5px;
    }
    .section {
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 2rem;
    }
  </style>
</head>
<body>
  <h1 id="material-title">Material Viewer</h1>

  <div class="section">
    <h2>üßä Crystal Structure</h2>
    <div id="structureStatus" class="loading">Loading structure...</div>

    <div class="viewer-controls">
      <label><input type="checkbox" id="bonds-toggle" checked /> Bonds</label>
      <label><input type="checkbox" id="packed-toggle" /> Packed cell</label>
      <label><input type="checkbox" id="vdw-toggle" /> vdw radius</label>

      <div style="margin-top: 10px;">
        Supercell: 
        <select id="scell-x"><option>1</option><option>2</option><option selected>3</option><option>4</option></select> √ó
        <select id="scell-y"><option>1</option><option>2</option><option selected>3</option><option>4</option></select> √ó
        <select id="scell-z"><option>1</option><option selected>1</option><option>2</option></select>
      </div>

      <div style="margin-top: 10px;">
        Camera: 
        <button id="view-x">X</button>
        <button id="view-y">Y</button>
        <button id="view-z">Z</button>
        <button id="home-btn">üè† Reset</button>
      </div>

      <div style="margin-top: 10px;">
        <label><input type="checkbox" id="labels-toggle" /> Atom labels</label>
      </div>
    </div>

    <div id="viewer"></div>
  </div>

<script>
let viewer = null;
let baseModel = null;
let atomLabels = [];
let labelsVisible = false;
let currentBonds = true;
let useVDW = false;
let supercell = [3, 3, 1];

// Load and parse CIF data
function load3DStructure() {
  viewer = $3Dmol.createViewer('viewer', {
    backgroundColor: "white"
  });

  fetch("POSCAR.cif")
    .then(res => res.text())
    .then(cifData => {
      baseModel = $3Dmol.GLModel.parseMolData(cifData, "cif");
      renderStructure();
      document.getElementById("structureStatus").innerHTML =
        `<div class="success">‚úì Structure loaded. Customize with the controls below.</div>`;
    })
    .catch(err => {
      document.getElementById("structureStatus").innerHTML =
        `<div class="error">Error loading CIF: ${err.message}</div>`;
    });
}

// Render with current settings
function renderStructure() {
  if (!viewer || !baseModel) return;

  viewer.clear();
  const model = viewer.addModel(baseModel.clone(), "cif");
  model.replicateUnitCell(supercell[0], supercell[1], supercell[2]);

  model.setStyle({}, {
    stick: currentBonds ? { radius: 0.15 } : {},
    sphere: useVDW ? { scale: 1.0 } : { scale: 0.35 }
  });

  viewer.addUnitCell();

  // Remove old labels
  atomLabels.forEach(label => viewer.removeLabel(label));
  atomLabels = [];

  // Add new labels if requested
  if (labelsVisible) {
    const atoms = viewer.selectedAtoms();
    atoms.forEach(atom => {
      const label = viewer.addLabel(atom.elem, {
        position: { x: atom.x, y: atom.y, z: atom.z + 0.5 },
        fontSize: 14,
        fontColor: "black",
        showBackground: false
      });
      atomLabels.push(label);
    });
  }

  viewer.zoomTo();
  viewer.render();
}

document.addEventListener('DOMContentLoaded', () => {
  load3DStructure();

  document.getElementById('bonds-toggle').addEventListener('change', e => {
    currentBonds = e.target.checked;
    renderStructure();
  });

  document.getElementById('packed-toggle').addEventListener('change', e => {
    useVDW = e.target.checked;
    renderStructure();
  });

  document.getElementById('labels-toggle').addEventListener('change', e => {
    labelsVisible = e.target.checked;
    renderStructure();
  });

  ['scell-x', 'scell-y', 'scell-z'].forEach((id, i) => {
    document.getElementById(id).addEventListener('change', () => {
      supercell[i] = parseInt(document.getElementById(id).value);
      renderStructure();
    });
  });

  document.getElementById('home-btn').addEventListener('click', () => {
    viewer.zoomTo();
    viewer.render();
  });

  document.getElementById('view-x').addEventListener('click', () => {
    viewer.setViewStyle({ projection: "orthographic" });
    viewer.rotate(0, 90);
    viewer.render();
  });

  document.getElementById('view-y').addEventListener('click', () => {
    viewer.setViewStyle({ projection: "orthographic" });
    viewer.rotate(90, 0);
    viewer.render();
  });

  document.getElementById('view-z').addEventListener('click', () => {
    viewer.setViewStyle({ projection: "orthographic" });
    viewer.rotate(0, 0);
    viewer.render();
  });

  // Set dynamic material name (optional)
  const pathParts = window.location.pathname.split('/');
  const folderName = pathParts[pathParts.length - 2] || "Unknown";
  document.getElementById("material-title").innerHTML =
    `Material: ${folderName}`;
});
</script>
</body>
</html>
